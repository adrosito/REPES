// equipos.js
const API_BASE = 'https://open.faceit.com/data/v4';
const API_KEY  = '8545dcce-9083-41d2-a956-f8772ad3d75a';  // ← reemplaza aquí

async function apiFetch(path) {
  const res = await fetch(API_BASE + path, {
    headers: { Authorization: `Bearer ${API_KEY}` }
  });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error(`API error ${res.status}: ${txt}`);
  }
  return res.json();
}

const champSelect = document.getElementById('champSelect');
const loadTeamsBtn= document.getElementById('loadTeams');
const teamGrid    = document.getElementById('teamGrid');
const modalBg     = document.getElementById('modalBackdrop');
const closeModal  = document.getElementById('closeModal');
const modalTitle  = document.getElementById('modalTeamName');
const modalPlayers= document.getElementById('modalPlayers');

// 1) Carga los torneos (igual que en liga.js)
async function loadChampionships() {
  const { items } = await apiFetch(`/championships?game=cs2&type=ongoing&limit=10`);
  champSelect.innerHTML = '';
  items.forEach(ch => {
    const opt = document.createElement('option');
    opt.value = ch.championship_id;
    opt.textContent = ch.name;
    champSelect.appendChild(opt);
  });
  loadTeamsBtn.disabled = false;
}

// 2) Al click "Cargar Equipos"
loadTeamsBtn.addEventListener('click', async () => {
  const champId = champSelect.value;
  loadTeamsBtn.disabled = true;
  teamGrid.innerHTML = 'Cargando...';
  try {
    // Obtener todas las suscripciones (teams) del torneo
    const subs = await apiFetch(`/championships/${champId}/subscriptions?limit=100`);
    const teams = subs.items.filter(s => s.entity_type==='team');
    teamGrid.innerHTML = '';
    for (let sub of teams) {
      const team = await apiFetch(`/teams/${sub.entity_id}`);
      const div = document.createElement('div');
      div.className = 'team-card';
      div.innerHTML = `
        <img src="${team.avatar}" alt="">
        <div class="team-name">${team.name}</div>
        ${team.country ? `<img class="team-flag" src="https://flagcdn.com/24x18/${team.country.toLowerCase()}.png">` : ''}
      `;
      div.addEventListener('click', ()=> openModal(team));
      teamGrid.appendChild(div);
    }
  } catch (err) {
    teamGrid.innerHTML = `Error: ${err.message}`;
  } finally {
    loadTeamsBtn.disabled = false;
  }
});

// abre el modal con la plantilla del equipo
async function openModal(team) {
  modalTitle.textContent = team.name;
  modalPlayers.innerHTML = 'Cargando jugadores...';
  modalBg.style.display = 'flex';
  try {
    const plist = await apiFetch(`/teams/${team.team_id}/players`);
    modalPlayers.innerHTML = '';
    plist.items.forEach(p => {
      const div = document.createElement('div');
      div.className = 'player';
      div.innerHTML = `
        <img src="${p.avatar}" alt="">
        <div class="name">${p.nickname}</div>
      `;
      modalPlayers.appendChild(div);
    });
  } catch (_) {
    modalPlayers.innerHTML = 'No se pudo cargar jugadores';
  }
}

closeModal.addEventListener('click', ()=>{
  modalBg.style.display = 'none';
});

// inicializa
loadChampionships().catch(e => {
  champSelect.innerHTML = `<option>Error al cargar torneos</option>`;
  console.error(e);
});
